<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contador de Hist√≥rias AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-blue-50 flex items-center justify-center min-h-screen">

    <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl p-8 m-4">
        <header class="text-center mb-6">
            <h1 class="text-4xl font-bold text-blue-800">Contador de Hist√≥rias AI üéôÔ∏è</h1>
            <p class="text-lg text-gray-600 mt-2">D√™-me um tema e eu criarei uma hist√≥ria infantil m√°gica para voc√™.</p>
        </header>

        <!-- √Årea de Input -->
        <div class="mb-6">
            <div class="flex flex-col sm:flex-row gap-3">
                <input 
                    type="text" 
                    id="story-theme" 
                    placeholder="Ex: um coelho que queria voar..."
                    class="flex-1 border border-gray-300 rounded-lg py-3 px-5 text-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition"
                >
                <button 
                    id="generate-button" 
                    class="bg-blue-600 text-white rounded-lg px-8 py-3 text-lg font-semibold shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition transform hover:scale-105 active:scale-95 disabled:bg-gray-400"
                >
                    Criar Hist√≥ria
                </button>
            </div>
            
            <!-- Bot√µes de A√ß√£o -->
            <div id="action-buttons" class="flex flex-wrap gap-3 mt-4 justify-center hidden">
                <button id="clear-button" class="flex items-center gap-2 bg-gray-200 text-gray-700 rounded-lg px-4 py-2 text-sm font-medium hover:bg-gray-300 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12.578 0a48.108 48.108 0 013.478-.397m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>
                    Limpar
                </button>
                <button id="save-pdf-button" class="flex items-center gap-2 bg-green-100 text-green-700 rounded-lg px-4 py-2 text-sm font-medium hover:bg-green-200 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                    Salvar PDF
                </button>
                <!-- Bot√£o Salvar √Åudio REMOVIDO -->
            </div>
        </div>

        <!-- √Årea de Resultado -->
        <div id="result-container" class="bg-gray-50 border border-gray-200 rounded-lg p-6 min-h-[200px] relative hidden">
            <!-- Overlay de Loading -->
            <div id="loading-spinner" class="absolute inset-0 bg-white bg-opacity-70 flex items-center justify-center rounded-lg z-10 hidden">
                <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
            </div>

            <!-- Bot√£o de √Åudio (escondido) -->
            <button id="play-audio-button" class="absolute top-4 right-4 bg-blue-100 text-blue-700 rounded-full p-3 shadow-sm hover:bg-blue-200 focus:outline-none transition transform hover:scale-110 hidden disabled:opacity-50" title="Ouvir a hist√≥ria">
                <!-- √çcone Play -->
                <svg id="icon-play" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.348a1.125 1.125 0 010 1.972l-11.54 6.347a1.125 1.125 0 01-1.667-.986V5.653z" />
                </svg>
                <!-- √çcone Pause (escondido) -->
                <svg id="icon-pause" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 hidden">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25v13.5m-7.5-13.5v13.5" />
                </svg>
                <!-- √çcone Loading √Åudio (escondido) -->
                <svg id="icon-audio-loading" class="w-6 h-6 animate-spin hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </button>
            
            <!-- Texto da Hist√≥ria -->
            <p id="story-text" class="text-gray-800 text-lg leading-relaxed whitespace-pre-wrap"></p>
        </div>
        
        <!-- √Årea de Erro -->
        <div id="error-message" class="bg-red-100 border border-red-300 text-red-800 rounded-lg p-4 mt-4 text-center hidden">
            <strong>Ops!</strong> <span id="error-text"></span>
        </div>
    </div>

    <script>
        // --- Endpoints da API ---
        // ATEN√á√ÉO: Substitua pela URL do seu backend no Render
        const API_URL_STORY = "https://contador-historias-api.onrender.com/gerar_historia";
        // A API de √ÅUDIO FOI REMOVIDA.

        // --- Elementos do DOM ---
        const themeInput = document.getElementById('story-theme');
        const generateButton = document.getElementById('generate-button');
        const resultContainer = document.getElementById('result-container');
        const loadingSpinner = document.getElementById('loading-spinner');
        const storyTextElement = document.getElementById('story-text');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        
        // --- Elementos de √Åudio ---
        const playButton = document.getElementById('play-audio-button');
        const iconPlay = document.getElementById('icon-play');
        const iconPause = document.getElementById('icon-pause');
        const iconAudioLoading = document.getElementById('icon-audio-loading');
        
        // --- Bot√µes de A√ß√£o ---
        const actionButtonsContainer = document.getElementById('action-buttons');
        const clearButton = document.getElementById('clear-button');
        const savePdfButton = document.getElementById('save-pdf-button');
        // Bot√£o Salvar √Åudio REMOVIDO

        // --- Vari√°veis de Estado ---
        let currentStoryText = ""; // Armazena o texto da hist√≥ria atual
        let currentUtterance = null; // Armazena a "fala" atual

        // --- Fun√ß√µes Auxiliares de √Åudio (REMOVIDAS) ---
        // pcmToWav, base64ToArrayBuffer, etc. n√£o s√£o mais necess√°rias.

        // --- Fun√ß√µes Principais ---
        
        function showLoading(isLoading) {
            loadingSpinner.classList.toggle('hidden', !isLoading);
            generateButton.disabled = isLoading;
            themeInput.disabled = isLoading;
        }

        function showError(message) {
            errorMessage.classList.remove('hidden');
            errorText.textContent = message;
        }
        
        function resetState() {
            errorMessage.classList.add('hidden');
            resultContainer.classList.add('hidden');
            storyTextElement.textContent = "";
            themeInput.value = ""; 
            currentStoryText = "";
            
            playButton.classList.add('hidden');
            actionButtonsContainer.classList.add('hidden'); 
            
            iconPlay.classList.remove('hidden');
            iconPause.classList.add('hidden');
            iconAudioLoading.classList.add('hidden');
            
            // ### NOVO: Para a fala nativa ###
            if (currentUtterance) {
                window.speechSynthesis.cancel(); // Para a fala
                currentUtterance = null;
            }
        }

        // 1. GERAR HIST√ìRIA (Texto)
        async function handleGenerateStory() {
            const query = themeInput.value.trim();
            if (!query) {
                showError("Por favor, digite um tema para a hist√≥ria.");
                return;
            }
            
            resetState();
            showLoading(true);
            resultContainer.classList.remove('hidden');

            try {
                if (API_URL_STORY.includes("COLE_A_URL_DO_SEU_BACKEND_AQUI")) {
                    throw new Error("A URL da API no index.html ainda n√£o foi configurada!");
                }
            
                const response = await fetch(API_URL_STORY, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: query })
                });

                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.detail || "Erro do servidor ao gerar hist√≥ria.");
                }

                const data = await response.json();
                currentStoryText = data.story_text;
                storyTextElement.textContent = currentStoryText;
                
                playButton.classList.remove('hidden'); 
                actionButtonsContainer.classList.remove('hidden');

            } catch (error) {
                console.error("Erro em handleGenerateStory:", error);
                showError(error.message);
                resultContainer.classList.add('hidden');
            } finally {
                showLoading(false);
            }
        }

        // 2. GERAR √ÅUDIO (Voz) - ### FUN√á√ÉO TOTALMENTE NOVA (V1.2) ###
        async function handlePlayAudio() {
            if (!currentStoryText) return;
            
            const synth = window.speechSynthesis;

            // Se estiver falando, PAUSA
            if (synth.speaking && currentUtterance) {
                synth.pause();
                iconPlay.classList.remove('hidden');
                iconPause.classList.add('hidden');
                return;
            }

            // Se estiver pausado, CONTINUA
            if (synth.paused && currentUtterance) {
                synth.resume();
                iconPlay.classList.add('hidden');
                iconPause.classList.remove('hidden');
                return;
            }

            // Se for a primeira vez (ou se terminou), GERA a fala
            iconPlay.classList.add('hidden');
            iconAudioLoading.classList.remove('hidden'); // Usa o mesmo √≠cone de loading

            // Cria o objeto de "fala"
            currentUtterance = new SpeechSynthesisUtterance(currentStoryText);
            
            // Tenta encontrar uma voz em Portugu√™s do Brasil
            const voices = synth.getVoices();
            let brVoice = voices.find(v => v.lang === 'pt-BR');
            
            // Se n√£o achar, usa a voz padr√£o do navegador
            currentUtterance.voice = brVoice || voices.find(v => v.default);
            currentUtterance.lang = 'pt-BR';
            currentUtterance.rate = 0.9; // Um pouco mais devagar para hist√≥rias

            currentUtterance.onstart = () => {
                iconAudioLoading.classList.add('hidden');
                iconPause.classList.remove('hidden');
                playButton.disabled = false;
            };

            currentUtterance.onend = () => {
                iconPlay.classList.remove('hidden');
                iconPause.classList.add('hidden');
                currentUtterance = null;
            };
            
            currentUtterance.onerror = (e) => {
                console.error("Erro no SpeechSynthesis:", e);
                showError("Seu navegador n√£o conseguiu tocar o √°udio.");
                iconAudioLoading.classList.add('hidden');
                iconPlay.classList.remove('hidden');
                playButton.disabled = false;
            };
            
            // Tenta carregar as vozes (necess√°rio em alguns navegadores)
            if (voices.length === 0) {
                 synth.onvoiceschanged = () => {
                    const newVoices = synth.getVoices();
                    brVoice = newVoices.find(v => v.lang === 'pt-BR');
                    currentUtterance.voice = brVoice || newVoices.find(v => v.default);
                    synth.speak(currentUtterance);
                 };
            } else {
                synth.speak(currentUtterance);
            }
        }

        // --- NOVAS FUN√á√ïES DOS BOT√ïES ---

        function handleClearChat() {
            resetState();
        }

        function handleSavePDF() {
            if (!currentStoryText) return;
            
            const theme = themeInput.value.trim() || "historia";
            const filename = `${theme.substring(0, 20)}.pdf`;
            
            const element = document.createElement('div');
            element.style.padding = '20px';
            element.style.fontSize = '16px';
            element.style.lineHeight = '1.6';
            element.innerHTML = `<h1>${theme}</h1><br><p>${currentStoryText.replace(/\n/g, '<br>')}</p>`;

            html2pdf().from(element).set({
                margin: 1,
                filename: filename,
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            }).save();
        }
        
        // Fun√ß√£o de Salvar √Åudio REMOVIDA

        // --- Event Listeners ---
        generateButton.addEventListener('click', handleGenerateStory);
        themeInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleGenerateStory();
        });
        playButton.addEventListener('click', handlePlayAudio);
        
        clearButton.addEventListener('click', handleClearChat);
        savePdfButton.addEventListener('click', handleSavePDF);

    </script>
</body>
</html>
